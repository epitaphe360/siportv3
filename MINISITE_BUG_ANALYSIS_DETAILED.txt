# COMPREHENSIVE BUG ANALYSIS - MINISITE SYSTEM

## Critical Bugs Found

### 1. DATA STRUCTURE MISMATCH IN MINISITEPREVIEW.tsx
File: /home/user/siportv3/src/components/minisite/MiniSitePreview.tsx
Lines: 30-43 (Interface), 177-182 (Usage), 221-226 (Critical issue)

Problem: 
- The MiniSiteData interface expects `theme` to be an object with properties:
  { primaryColor, secondaryColor, accentColor, fontFamily }
- But the database schema stores `theme` as a string (theme name like 'default')
- Colors are stored in a separate `custom_colors` field (Record<string, string>)

Impact: CRITICAL
- Line 177: `const theme = miniSiteData.theme ||` will receive a string, not an object
- Line 223: `${theme.primaryColor}, ${theme.secondaryColor}` will fail with undefined errors
- Colors won't display correctly on hero section

Fix Required:
- Update interface to match database schema
- Transform custom_colors into theme object structure OR
- Update database schema to match expected interface

---

### 2. INCORRECT PROPERTY ACCESSOR IN MINISITEPREVIEW.tsx
File: /home/user/siportv3/src/components/minisite/MiniSitePreview.tsx
Lines: 137-140 (getSection function), 221-269 (Usage)

Problem:
- getSection returns: { type: 'hero', title: '...', content: {...}, visible, order }
- But code accesses via: heroSection.data?.backgroundImage (WRONG!)
- Should be: heroSection.content?.backgroundImage

Locations of bug:
- Line 221: heroSection.data?.backgroundImage  → should be heroSection.content?.backgroundImage
- Line 222: heroSection.data.backgroundImage    → should be heroSection.content.backgroundImage
- Line 245: heroSection.data?.title             → should be heroSection.content?.title
- Line 253: heroSection.data?.subtitle          → should be heroSection.content?.subtitle
- Line 255: heroSection.data?.ctaText           → should be heroSection.content?.ctaText
- Line 265: heroSection.data.ctaLink            → should be heroSection.content.ctaLink
- Line 269: heroSection.data.ctaText            → should be heroSection.content.ctaText
- Line 288: aboutSection.data?.title            → should be aboutSection.content?.title
- Line 290: aboutSection.data?.description      → should be aboutSection.content?.description
- Line 291: aboutSection.data?.description      → should be aboutSection.content?.description

Impact: CRITICAL - All mini-site rendering will fail because section data won't be found

---

### 3. WRONG IDENTIFIER USED IN MINISITEEDITOR.tsx
File: /home/user/siportv3/src/components/minisite/MiniSiteEditor.tsx
Lines: 359 (load), 403 (save)

Problem:
- getMiniSite expects exhibitorId parameter
- updateMiniSite expects exhibitorId parameter
- But code passes user.id instead

Code at line 359:
```
const miniSite = await SupabaseService.getMiniSite(user.id);
```
Should be:
```
const miniSite = await SupabaseService.getMiniSite(exhibitorId);
```

Code at line 403:
```
await SupabaseService.updateMiniSite(user.id, miniSiteData);
```
Should be:
```
await SupabaseService.updateMiniSite(exhibitorId, miniSiteData);
```

Impact: CRITICAL
- Mini-sites won't load for exhibitors (wrong ID used in database query)
- Mini-sites won't save for exhibitors
- Users will see "Impossible de charger le mini-site" error

Database Query Impact:
- getMiniSite does: .eq('exhibitor_id', exhibitorId)
- Passing user.id will search for exhibitor with id = user.id (wrong)
- No exhibitor with user.id as their exhibitor ID exists

---

### 4. INCOMPLETE VALIDATION IN CREATE-MINI-SITE.js
File: /home/user/siportv3/server/create-mini-site.js
Lines: 114-117 (products validation)

Problem:
- Only validates that products is an array with max 100 items
- Doesn't validate structure of each product
- Products can be null/invalid objects

Missing validations:
- Each product needs: name, description, image, features, price
- No type checking for product fields
- No length validation for product names/descriptions

Impact: MEDIUM
- Invalid product data can be saved to database
- Frontend will crash when trying to display products

---

### 5. INCORRECT SECTION CONTENT STRUCTURE IN CREATE-MINI-SITE.js
File: /home/user/siportv3/server/create-mini-site.js
Lines: 151-156

Problem:
The sections created don't match expected structure:

Current code (WRONG):
```javascript
const sections = [
  { type: 'hero', content: { company, description, logo: logoUrl } },
  { type: 'products', content: { products } },
  { type: 'socials', content: { socials } },
  { type: 'documents', content: { documents } }
];
```

Hero section should have:
```javascript
{ 
  type: 'hero', 
  content: { 
    title: company,           // NOT 'company'
    subtitle: description,    // NOT 'description'
    backgroundImage: logoUrl, // NOT 'logo'
    ctaText: '...',
    ctaLink: '#products'
  }
}
```

Impact: HIGH
- Hero sections won't render correctly
- Custom colors and styling won't work
- Field names don't match MiniSiteEditor expectations

---

### 6. INVALID CUSTOM COLORS INITIALIZATION
File: /home/user/siportv3/server/create-mini-site.js
Line: 161

Problem:
```javascript
custom_colors: {},
```

Should be:
```javascript
custom_colors: {
  primaryColor: '#1e40af',
  secondaryColor: '#3b82f6',
  accentColor: '#60a5fa',
  fontFamily: 'Inter'
},
```

Impact: MEDIUM
- Colors won't display on mini-site
- Default colors from fallback at MiniSitePreview line 178 will be used
- User customization won't work

---

### 7. MISSING VALIDATION FOR SOCIALS AND DOCUMENTS
File: /home/user/siportv3/server/create-mini-site.js
Lines: 85-120

Problem:
- No validation for 'socials' field (can be any value)
- No validation for 'documents' field (can be any value)
- These fields are accepted without checking type or content

Impact: LOW-MEDIUM
- Invalid data can be saved
- Frontend might crash if accessing undefined properties

---

### 8. INCONSISTENT NAMING: theme vs custom_colors
File: /home/user/siportv3/src/services/supabaseService.ts
Lines: 35-39 (MiniSiteData interface), 61-62 (MiniSiteDB interface)

Problem:
MiniSiteData interface:
```
theme: string;
custom_colors?: Record<string, string>;
```

But should probably be:
```
theme: {
  primaryColor: string;
  secondaryColor: string;
  accentColor: string;
  fontFamily: string;
};
```

OR the database schema should match the TypeScript interface.

Impact: HIGH
- Frontend expects different structure than backend provides
- Type casting with `as any` required in multiple places
- Data transformation is error-prone

---

### 9. MISSING ERROR HANDLING FOR INCREMENT VIEW COUNT
File: /home/user/siportv3/src/services/supabaseService.ts
Lines: 867-876

Problem:
```javascript
static async incrementMiniSiteViews(exhibitorId: string): Promise<void> {
  ...
  try {
    await safeSupabase.rpc('increment_view_count', { exhibitor_id_param: exhibitorId });
  } catch (error) {
    console.error('Erreur incrémentation vues:', error);
  }
}
```

Issues:
- Error is silently caught, no feedback to caller
- If RPC function doesn't exist, will fail silently
- No validation of exhibitorId parameter
- Called in MiniSitePreview line 120 without error handling

Impact: LOW
- View counts may not increment
- No user feedback if operation fails

---

### 10. WRONG PARAMETER NAME IN RPC CALL
File: /home/user/siportv3/src/services/supabaseService.ts
Line: 872

Problem:
```javascript
await safeSupabase.rpc('increment_view_count', { exhibitor_id_param: exhibitorId });
```

This assumes the RPC function expects parameter named 'exhibitor_id_param'.
If the actual parameter name is different (e.g., 'id', 'exhibitor_id'), the function will fail.

Impact: MEDIUM
- RPC function won't receive the exhibitor ID
- View counts won't increment at all
- Silent failure with no error indication

---

## Summary of Critical Issues

1. **Data structure mismatch** - Theme format doesn't match between DB and frontend
2. **Wrong property accessor** - Accessing '.data' instead of '.content' on sections
3. **Wrong identifier type** - Using user.id instead of exhibitorId in getMiniSite/updateMiniSite
4. **Incomplete validation** - Product validation missing structure checks
5. **Incorrect section structure** - Field names don't match expected interface
6. **Invalid colors** - Empty custom_colors object breaks styling
7. **Missing validation** - socials and documents fields not validated

## Files Affected

- /home/user/siportv3/src/components/minisite/MiniSitePreview.tsx (CRITICAL - 10 bugs)
- /home/user/siportv3/src/components/minisite/MiniSiteEditor.tsx (CRITICAL - 2 bugs)
- /home/user/siportv3/server/create-mini-site.js (HIGH - 3 bugs)
- /home/user/siportv3/src/services/supabaseService.ts (MEDIUM - 3 bugs)

